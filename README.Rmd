---
output: github_document
---

<!-- README.md is generated from README.Rmd. Please edit that file -->

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>",
  fig.path = "man/figures/README-",
  out.width = "100%"
)
knitr::opts_chunk$set(fig.width=10, fig.height=4)
```
# epichannel

<!-- badges: start -->
[![Lifecycle: experimental](https://img.shields.io/badge/lifecycle-experimental-orange.svg)](https://www.tidyverse.org/lifecycle/#experimental)
[![CRAN status](https://www.r-pkg.org/badges/version/epichannel)](https://cran.r-project.org/package=epichannel)
<!-- badges: end -->

The goal of epichannel is to create classical endemic channel for Epidemiological Surveillance in Public Health.

## Installation

<!-- You can install the released version of epichannel from [CRAN](https://CRAN.R-project.org) with: -->

``` r
#install.packages("epichannel")
devtools::install_github("avallecam/epichannel")
```

## Example

This is a basic example which shows you how to solve a common problem:

```{r example}
library(epichannel)
## basic example code
```

- import data

```{r}
library(tidyverse)

dengv <-
  readr::read_csv("https://dengueforecasting.noaa.gov/Training/Iquitos_Training_Data.csv") %>%
  mutate(year = lubridate::year(week_start_date),
         epiweek = lubridate::epiweek(week_start_date)) %>%
  mutate(adm="iquitos") %>%
  # cases per season - replace wiht a dummy year
  mutate(year = str_replace(season,"(.+)/(.+)","\\1") %>% as.double())

# dengv %>% count(year,season,lag_year)

dengv %>% glimpse()

# dengv %>%
#   ggplot(aes(x = week_start_date,y = total_cases)) +
#   geom_col()

popdb <-
  readr::read_csv("https://dengueforecasting.noaa.gov/PopulationData/Iquitos_Population_Data.csv") %>%
  janitor::clean_names() %>%
  mutate(adm="iquitos")

popdb %>% glimpse()

# popdb %>% count(year)
# dengv %>% count(year)
# dengv %>% left_join(popdb)
```

- first, adapt

```{r}
epi_adapted <-
  epi_adapt_timeserie(db_disease = dengv,
                      db_population = popdb,
                      var_admx = adm,
                      # var_year = year, # must be a common variable between datasets
                      # var_week = epiweek,
                      var_year = year, # not working - need to create pseudo-years
                      var_week = season_week,
                      var_event_count = total_cases,
                      var_population = estimated_population)
```

- second, filter

```{r}
disease_now <- epi_adapted %>%
  filter(var_year==max(var_year))

disease_pre <- epi_adapted %>%
  filter(var_year!=max(var_year))
```

- third, create

```{r}
disease_channel <-
  epi_create_channel(time_serie = disease_pre,
                     disease_name = "dengv")

disease_channel

```

- fourth, join and ggplot

```{r}
epi_join_channel(disease_channel = disease_channel,
                 disease_now = disease_now) %>%
  # ggplot
  epi_plot_channel() +
  labs(title = "DENGV Endemic Channel. Iquitos, Peru 2008/2009",
       caption = "Source: https://dengueforecasting.noaa.gov/",
       # x = "epiweeks",
       x = "Seasonal week",
       y = "Number of cases") +
  theme_bw()
```

